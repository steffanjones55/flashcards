<div id="flashcards" class="hidden">
  <p id="progress-text"></p>
  <h2 id="unit-title" style="margin-top:0; color: #f472b6; font-style: italic;"></h2>
  
  <div id="card-container">
    <div class="card" id="flashcard-element" onclick="flipCard()">
      <span id="card-text"></span>
    </div>
  </div>

  <div id="review-cleanup" class="hidden" style="background: #334155; padding: 20px; border-radius: 20px; margin-bottom: 20px;">
    <h3>Review Complete!</h3>
    <p>Uncheck the words you have mastered:</p>
    <div id="cleanup-list" style="text-align: left; margin-bottom: 20px; max-height: 200px; overflow-y: auto;"></div>
    <button onclick="confirmCleanup()" style="background: #10b981; width: 100%;">Confirm & Continue</button>
  </div>

  <div id="controls">
    <div style="margin-top: 20px;">
      <button onclick="nextCard()" style="background: #db2777; color: white; padding: 15px 30px;">Next Card</button>
      <button id="save-btn" onclick="repeatWord()" style="background: #334155;">Save for Later</button>
      <button id="review-now-btn" class="hidden" onclick="reviewSavedNow()" style="background-color: #0ea5e9; color: white;">Review Saved</button>
      <br><br>
      <button onclick="goHome()" style="background: transparent; border: none; color: #94a3b8;">Back to Home</button>
    </div>
  </div>
</div>

<script>
    // ... (Keep your UNITS data as is) ...

    let direction = "welsh-to-english";
    let words = []; 
    let index = 0; 
    let showingFront = true;
    let trickyWords = []; 

    let backupWords = [];
    let backupIndex = 0;
    let mainUnitTitle = "";
    let isReviewingTricky = false;

    function buildTestUnitOptions() {
      const div = document.getElementById("test-units");
      div.innerHTML = "";
      Object.keys(UNITS).forEach(unit => {
        div.innerHTML += `<label><input type="checkbox" value="${unit}"> ${unit.replace('unit', 'Unit ').replace('_', ' ')}</label>`;
      });
    }

    function startUnit(unitKey) {
      trickyWords = [];
      document.getElementById("review-now-btn").classList.add("hidden");
      mainUnitTitle = unitKey.toUpperCase().replace('_', ' ');
      words = [...UNITS[unitKey]].sort(() => Math.random() - 0.5);
      index = 0;
      isReviewingTricky = false;
      showInterface();
      showCard();
    }

    function showInterface() {
      document.getElementById("home").classList.add("hidden");
      document.getElementById("flashcards").classList.remove("hidden");
      document.getElementById("card-container").classList.remove("hidden");
      document.getElementById("controls").classList.remove("hidden");
      document.getElementById("review-cleanup").classList.add("hidden");
      document.getElementById("unit-title").innerText = mainUnitTitle;
    }

    function nextCard() {
      index++;
      if (index >= words.length) {
        if (isReviewingTricky) {
          showCleanupScreen();
        } else {
          // End of main unit: Check if there are tricky words left
          if (trickyWords.length > 0) {
            alert("Main unit finished! Now, let's master those tricky words...");
            reviewSavedNow();
          } else {
            alert("Unit complete! Da iawn! ðŸŽ‰"); // Add confetti library trigger here
            goHome();
          }
        }
        return;
      }
      showingFront = true;
      showCard();
    }

    function showCleanupScreen() {
      document.getElementById("card-container").classList.add("hidden");
      document.getElementById("controls").classList.add("hidden");
      document.getElementById("review-cleanup").classList.remove("hidden");
      
      const listDiv = document.getElementById("cleanup-list");
      listDiv.innerHTML = "";
      trickyWords.forEach((word, i) => {
        listDiv.innerHTML += `
          <div style="margin-bottom: 10px;">
            <input type="checkbox" id="tricky-${i}" checked data-index="${i}">
            <label for="tricky-${i}">${word.front} (${word.back})</label>
          </div>
        `;
      });
    }

    function confirmCleanup() {
      // Filter trickyWords based on what is still checked
      const checkboxes = document.querySelectorAll("#cleanup-list input");
      const remainingTricky = [];
      checkboxes.forEach((cb, i) => {
        if (cb.checked) {
          remainingTricky.push(trickyWords[i]);
        }
      });
      
      trickyWords = remainingTricky;

      if (!backupWords || backupWords.length === 0) {
        // We reached the end of the unit and the review session
        if (trickyWords.length > 0) {
          alert("A few still to go! Let's try again.");
          reviewSavedNow();
        } else {
          alert("All words mastered! Da iawn! ðŸŽ‰");
          goHome();
        }
      } else {
        resumeMainSession();
      }
    }

    function reviewSavedNow() {
      if (trickyWords.length === 0) return;
      if (!isReviewingTricky) {
        backupWords = [...words];
        backupIndex = index;
      }
      words = [...trickyWords].sort(() => Math.random() - 0.5);
      index = 0;
      isReviewingTricky = true;
      showingFront = true;
      
      showInterface();
      document.getElementById("review-now-btn").classList.add("hidden");
      document.getElementById("unit-title").innerText = "REVIEWING SAVED";
      document.getElementById("flashcard-element").classList.add("review-mode");
      showCard();
    }

    function resumeMainSession() {
      words = [...backupWords];
      index = backupIndex;
      backupWords = []; // Clear backup to signal main unit is done
      isReviewingTricky = false;
      showingFront = true;

      showInterface();
      document.getElementById("flashcard-element").classList.remove("review-mode");
      if (trickyWords.length > 0) {
        document.getElementById("review-now-btn").classList.remove("hidden");
      }
      showCard();
    }

    function showCard() {
      const card = words[index];
      const text = document.getElementById("card-text");
      if (direction === "welsh-to-english") {
        text.innerText = showingFront ? card.front : card.back;
      } else {
        text.innerText = showingFront ? card.back : card.front;
      }
      document.getElementById("progress-text").innerText = `Card ${index + 1} of ${words.length}`;
    }

    function repeatWord() {
      const currentWord = words[index];
      if (!trickyWords.some(w => w.front === currentWord.front)) {
        trickyWords.push(currentWord);
      }
      document.getElementById("review-now-btn").classList.remove("hidden");
      const saveBtn = document.getElementById("save-btn");
      saveBtn.innerText = "Saved! âœ¨";
      setTimeout(() => saveBtn.innerText = "Save for Later", 800);
    }

    function flipCard() { showingFront = !showingFront; showCard(); }
    function goHome() { location.reload(); }
    function toggleDirection() {
      direction = (direction === "welsh-to-english") ? "english-to-welsh" : "welsh-to-english";
      document.getElementById("directionBtn").innerText = direction === "welsh-to-english" ? "Welsh â†’ English" : "English â†’ Welsh";
    }
    
    // ... (Keep startTest and showGlossary as they are) ...
    buildTestUnitOptions();
</script>
